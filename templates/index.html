<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Simple transition for progress bar */
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
        /* Chart containers must have a defined height for Chart.js */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="h-full font-sans text-gray-900">
    
    <div class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <h1 class="text-3xl font-bold tracking-tight text-gray-900 text-center">
                News Analysis Engine
            </h1>
        </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <form id="analysis-form">
            <label for="query" class="block text-sm font-medium text-gray-700">
                Enter news topic
            </label>
            <div class="mt-1 flex rounded-md shadow-sm">
                <input type="text" name="query" id="query"
                    class="block w-full flex-1 rounded-none rounded-l-md border-gray-300 px-4 py-3 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    placeholder="e.g., 'Global AI Regulation'">
                <button type="submit" id="submit-button"
                    class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-indigo-600 px-6 py-3 text-sm font-medium text-white hover:bg-indigo-700 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    Analyze
                </button>
            </div>
        </form>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-4">

            <div class="lg:col-span-3 space-y-6">
                <div id="status-container" class="hidden">
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <div class="mb-4">
                            <div class="text-lg font-medium text-gray-800" id="status-message">
                                Initializing...
                            </div>
                            <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="status-log-container" class="hidden">
                            <h3 class="text-sm font-medium text-gray-600">Analysis Log:</h3>
                            <ul id="status-log" class="mt-2 h-32 overflow-y-auto rounded-md bg-gray-50 p-3 text-sm text-gray-500 space-y-1 border">
                                </ul>
                        </div>
                    </div>
                </div>

                <div id="error-container" class="hidden">
                    <div class="rounded-md bg-red-50 p-4 shadow-md border border-red-200">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Analysis Failed</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <p id="error-message">An unknown error occurred.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="welcome-container">
                    <div class="text-center bg-white rounded-lg shadow border border-gray-200 p-12">
                        <h2 class="text-xl font-medium text-gray-700">Welcome!</h2>
                        <p class="mt-2 text-gray-500">Please enter a search topic in the bar above to begin the analysis.</p>
                    </div>
                </div>
                
                <div id="results-dashboard" class="hidden space-y-6">
                    
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h2 class="text-xl font-semibold text-gray-900 border-b border-gray-200 pb-3">
                            Core Story
                        </h2>
                        <blockquote class="mt-4 border-l-4 border-indigo-500 bg-indigo-50 p-4 text-lg font-medium text-indigo-900" id="core-story-description">
                            </blockquote>
                        <div class="mt-3 text-right text-2xl font-bold text-indigo-600" id="core-story-agreement">
                            </div>
                    </div>

                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                        
                        <div class="space-y-6 lg:col-span-1">
                            <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                                <h2 class="text-lg font-semibold text-gray-900 mb-4">
                                    Overall Sentiment
                                </h2>
                                <div class="chart-container">
                                    <canvas id="sentiment-chart"></canvas>
                                </div>

                                <div class="mt-6 pt-4 border-t border-gray-200">
                                    <h3 class="text-base font-semibold text-gray-800 mb-3">Article Clusters</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <h4 class="text-sm font-medium text-green-600">Positive Articles</h4>
                                            <ul class="mt-1 list-none space-y-1 text-sm max-h-40 overflow-y-auto" id="positive-cluster-list">
                                                </ul>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-medium text-amber-600">Neutral Articles</h4>
                                            <ul class="mt-1 list-none space-y-1 text-sm max-h-40 overflow-y-auto" id="neutral-cluster-list">
                                                </ul>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-medium text-red-600">Negative Articles</h4>
                                            <ul class="mt-1 list-none space-y-1 text-sm max-h-40 overflow-y-auto" id="negative-cluster-list">
                                                </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                                <h2 class="text-lg font-semibold text-gray-900 mb-4">
                                    Key Nuances & Gaps
                                </h2>
                                <ul class="space-y-3 max-h-96 overflow-y-auto" id="coverage-gaps-list">
                                    </ul>
                            </div>
                        </div>
                        
                        <div class="space-y-6 lg:col-span-2">
                            <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                                <h2 class="text-lg font-semibold text-gray-900 mb-4">
                                    Share of Voice (Top Entities)
                                </h2>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entity</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voice Share</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="top-entities-table">
                                            </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                                <h2 class="text-lg font-semibold text-gray-900 mb-4">
                                    Article Credibility Breakdown
                                </h2>
                                <div class="overflow-x-auto max-h-[700px] overflow-y-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Article Title</th>
                                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="credibility-table">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-lg shadow border border-gray-200 p-6 sticky top-8">
                    <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-3">
                        Top 5 News
                    </h2>
                    <ul id="top-news-list" class="space-y-4 mt-4">
                        <li class="text-sm text-gray-500">Loading top news...</li>
                    </ul>
                </div>
            </div> </div> </div>

    <script>
        // --- Chart.js Global Variable ---
        let sentimentChart = null;

        // --- DOM Element References ---
        const form = document.getElementById('analysis-form');
        const queryInput = document.getElementById('query');
        const submitButton = document.getElementById('submit-button');
        
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const statusLogContainer = document.getElementById('status-log-container');
        const statusLog = document.getElementById('status-log');
        
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        
        const welcomeContainer = document.getElementById('welcome-container');
        const resultsDashboard = document.getElementById('results-dashboard');

        // --- EventSource Global Variable ---
        let eventSource = null;

        
        // --- NEW: Run on page load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch top news as soon as the page is ready
            fetchTopNews();

            // Attach the main form submission handler
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = queryInput.value.trim();
                if (!query) {
                    return;
                }
                startAnalysis(query);
            });
        });

        /**
         * NEW: Fetches and renders the top 5 news articles
         */
        async function fetchTopNews() {
            const list = document.getElementById('top-news-list');
            if (!list) return;

            list.innerHTML = `<li class="text-sm text-gray-500">Loading top news...</li>`;

            try {
                const response = await fetch('/get-top-news');
                if (!response.ok) {
                    throw new Error(`Network error: ${response.statusText}`);
                }
                const articles = await response.json();
                console.log(articles);

                // Handle errors from the NewsAPI itself
                if (articles.error) {
                    throw new Error(articles.error);
                }

                if (!Array.isArray(articles) || articles.length === 0) {
                    list.innerHTML = `<li class="text-sm text-gray-500">No top news found.</li>`;
                    return;
                }

                list.innerHTML = ''; // Clear loading
                
                articles.forEach(article => {
                    const li = document.createElement('li');
                    li.className = 'pb-4 border-b border-gray-200 last:pb-0 last:border-b-0';
                    
                    // Use fallback "N/A" if data is missing
                    const title = article.title || 'No Title Available';
                    const url = article.url || '#';
                    const description = article.description || 'No description available.';
                    const sourceName = article.source?.name || 'Unknown Source';

                    li.innerHTML = `
                        <a href="${url}" target="_blank" rel="noopener noreferrer" class="font-medium text-indigo-600 hover:text-indigo-800 hover:underline">
                            ${title}
                        </a>
                        <p class="text-sm text-gray-600 mt-1">
                            ${description}
                        </p>
                        <span class="text-xs text-gray-400 font-medium uppercase">${sourceName}</span>
                    `;
                    list.appendChild(li);
                });

            } catch (error) {
                console.error('Error fetching top news:', error);
                list.innerHTML = `<li class="text-sm text-red-600">Failed to load top news. Please try refreshing.</li>`;
            }
        }

        /**
         * Main form submission handler
         */
        function startAnalysis(query) {
            // 1. Reset the UI
            resetUI();

            // 2. Show status container
            welcomeContainer.classList.add('hidden');
            statusContainer.classList.remove('hidden');
            statusLogContainer.classList.remove('hidden');
            submitButton.disabled = true;
            submitButton.textContent = 'Analyzing...';
            
            // 3. Create the EventSource connection
            const encodedQuery = encodeURIComponent(query);
            eventSource = new EventSource(`/stream-analysis?query=${encodedQuery}`);

            // 4. Handle incoming messages
            eventSource.onmessage = (event) => {
                const eventData = JSON.parse(event.data);
                updateStatus(eventData);
            };

            // 5. Handle errors
            eventSource.onerror = (err) => {
                console.error("EventSource failed:", err);
                showError("Connection to the server failed. Please try again.");
                if (eventSource) eventSource.close();
                resetForm();
            };
        }

        /**
         * Updates the UI based on the SSE message
         */
        function updateStatus(eventData) {
            const { step, status, message, data } = eventData;

            // Add to log
            const logItem = document.createElement('li');
            logItem.textContent = `[${status}] ${message}`;
            statusLog.appendChild(logItem);
            statusLog.scrollTop = statusLog.scrollHeight; // Auto-scroll

            if (status === 'error') {
                showError(message);
                if (eventSource) eventSource.close();
                resetForm();
                return;
            }

            // Update progress bar (9 total steps)
            const progress = (step / 9) * 100;
            progressBar.style.width = `${progress}%`;
            statusMessage.textContent = message;

            if (status === 'complete') {
                statusMessage.textContent = "Analysis Complete!";
                if (eventSource) eventSource.close();
                resetForm();
                renderDashboard(data);
            }
        }

        /**
         * Renders the final dashboard with all results
         */
        function renderDashboard(data) {
            if (!data) {
                showError("No data was returned from the analysis.");
                return;
            }

            // Hide status, show results
            statusContainer.classList.add('hidden');
            resultsDashboard.classList.remove('hidden');

            // 1. Core Story
            // console.log(data.core_story.description)
            // console.log(data.core_story)
            document.getElementById('core-story-description').textContent = data.core_story?.description || 'N/A';
            document.getElementById('core-story-agreement').textContent = `${(data.core_story?.agreement_pct || 0).toFixed(1)}% Agreement`;


            // 2. Sentiment Chart
            renderSentimentChart(data.sentiment_summary?.distribution);
            renderSentimentClusters(data.sentiment_summary?.clusters);

            // 3. Coverage Gaps
            const gapsList = document.getElementById('coverage-gaps-list');
            gapsList.innerHTML = '';
            (data.coverage_gaps || []).forEach(gap => {
                const li = document.createElement('li');
                li.className = "p-4 bg-gray-50 rounded-md border border-gray-200";
                
                let articleLinksHtml = '';
                if (gap.article_urls && gap.article_urls.length > 0) {
                    articleLinksHtml = gap.article_urls.map((url, index) => {
                        if (!url) return '';
                        let displayUrl = url.replace(/^(https?:\/\/)?(www\.)?/, '');
                        if (displayUrl.length > 40) displayUrl = displayUrl.substring(0, 40) + '...';
                        return `<li class="mt-1"><a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 hover:underline break-all" title="${url}">
                            Article ${index + 1} (${displayUrl})
                        </a></li>`;
                    }).join('');
                } else {
                    articleLinksHtml = '<li class="text-gray-500 italic text-sm mt-1">No specific articles found for this gap.</li>';
                }
                
                li.innerHTML = `
                    <strong class="text-gray-800">${gap.description}</strong>
                    <span class="block text-sm text-gray-500 mt-1">
                        (Found in ${(gap.pct_of_articles || 0).toFixed(1)}% of articles)
                    </span>
                    <ul class="list-none space-y-1 text-sm mt-2 pt-2 border-t border-gray-200">
                        ${articleLinksHtml}
                    </ul>
                `;
                
                gapsList.appendChild(li);
            });
            if (!gapsList.hasChildNodes()) {
                gapsList.innerHTML = `<li class="text-gray-500 italic">No significant coverage gaps found.</li>`;
            }

            // 4. Share of Voice
            const entitiesTable = document.getElementById('top-entities-table');
            entitiesTable.innerHTML = '';
            (data.top_entities || []).forEach(entity => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">${entity.canonical_name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${(entity.percentage || 0).toFixed(1)}%</td>
                `;
                entitiesTable.appendChild(tr);
            });
            if (!entitiesTable.hasChildNodes()) {
                entitiesTable.innerHTML = `<tr><td colspan="2" class="px-4 py-3 text-gray-500 italic">No entities found.</td></tr>`;
            }

            // 5. Credibility
            const credibilityTable = document.getElementById('credibility-table');
            credibilityTable.innerHTML = '';
            (data.credibility_scores || []).forEach(article => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                
                // This is the part you asked about:
                const articleUrl = article.id || article.url || '#';
                const articleTitle = article.title || 'No Title Available'; // Fallback
                const articleSource = article.source || 'Unknown'; // Fallback

                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-bold ${getScoreColor(article.credibility_score)}">
                        ${(article.credibility_score || 0).toFixed(1)}
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">
                        <a href="${articleUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline">
                            ${articleTitle}
                        </a>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${articleSource}</td>
                `;
                credibilityTable.appendChild(tr);
            });
            if (!credibilityTable.hasChildNodes()) {
                credibilityTable.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-gray-500 italic">No articles to score.</td></tr>`;
            }
        }

        /**
         * Renders the doughnut chart for sentiment
         */
        function renderSentimentChart(distribution) {
            const ctx = document.getElementById('sentiment-chart').getContext('2d');
            
            const data = {
                labels: ['Positive', 'Neutral', 'Negative'],
                datasets: [{
                    label: 'Sentiment',
                    data: [
                        distribution?.Positive?.percentage || 0,
                        distribution?.Neutral?.percentage || 0,
                        distribution?.Negative?.percentage || 0
                    ],
                    backgroundColor: [
                        'rgb(34, 197, 94)',  // green-500
                        'rgb(245, 158, 11)', // amber-500
                        'rgb(239, 68, 68)'   // red-500
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };

            if (sentimentChart) {
                sentimentChart.destroy();
            }

            sentimentChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the article cluster hyperlinks
         */
        function renderSentimentClusters(clusters) {
            const posList = document.getElementById('positive-cluster-list');
            const neuList = document.getElementById('neutral-cluster-list');
            const negList = document.getElementById('negative-cluster-list');

            const emptyHtml = '<li class="text-gray-500 italic">No articles were found.</li>';

            const populateList = (listEl, urls) => {
                listEl.innerHTML = ''; // Clear old items
                if (!urls || urls.length === 0) {
                    listEl.innerHTML = emptyHtml;
                    return;
                }
                
                urls.forEach((url, index) => {
                    if (!url) return; // Skip null or empty URLs

                    // Truncate URL for display
                    let displayUrl = url.replace(/^(https?:\/\/)?(www\.)?/, '');
                    if (displayUrl.length > 45) {
                        displayUrl = displayUrl.substring(0, 45) + '...';
                    }
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 hover:underline break-all" title="${url}">
                            Article ${index + 1} (${displayUrl})
                        </a>
                    `;
                    listEl.appendChild(li);
                });
            };

            populateList(posList, clusters?.Positive);
            populateList(neuList, clusters?.Neutral);
            populateList(negList, clusters?.Negative);
        }

        /**
         * Helper to color-code credibility scores
         */
        function getScoreColor(score) {
            if (score >= 75) return 'text-green-600';
            if (score >= 50) return 'text-yellow-600';
            return 'text-red-600';
        }

        /**
         * Shows the error message container
         */
        function showError(message) {
            statusContainer.classList.add('hidden');
            resultsDashboard.classList.add('hidden');
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        /**
         * Resets the form button and loading state
         */
        function resetForm() {
            submitButton.disabled = false;
            submitButton.textContent = 'Analyze';
        }
        
        /**
         * Resets the entire UI to its initial state
         */
        function resetUI() {
            // Clear results
            resultsDashboard.classList.add('hidden');
            
            // Clear status
            statusContainer.classList.add('hidden');
            statusLog.innerHTML = '';
            progressBar.style.width = '0%';
            
            // Clear error
            errorContainer.classList.add('hidden');
            errorMessage.textContent = '';

            // Show welcome
            welcomeContainer.classList.remove('hidden');

            // Reset chart
            if (sentimentChart) {
                sentimentChart.destroy();
                sentimentChart = null;
            }
        }
    </script>
</body>
</html>