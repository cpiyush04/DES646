<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Analysis Dashboard</title>
    <style>
        /* --- Base & Typography --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 24px;
            background-color: #f8f9fa; /* Lighter gray background */
            color: #212529;
        }
        .container {
            max-width: 1400px;
            margin: auto;
        }
        h1 { color: #212529; text-align: center; }
        h2 {
            color: #343a40;
            border-bottom: 2px solid #007bff; /* Blue accent */
            padding-bottom: 8px;
            margin-top: 0;
            font-size: 1.5em;
        }

        /* --- Search Bar --- */
        .search-container {
            max-width: 800px;
            margin: 40px auto;
            text-align: center;
        }
        .search-container h1 {
            font-size: 2.8em;
            color: #343a40;
            font-weight: 600;
        }
        .search-bar {
            display: flex;
            border-radius: 50px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08); /* Softer, deeper shadow */
            overflow: hidden;
            background: #fff;
        }
        .search-bar input {
            border: none;
            outline: none;
            flex-grow: 1;
            padding: 20px 25px;
            font-size: 1.1em;
            color: #495057;
        }
        .search-bar button {
            border: none;
            outline: none;
            background: #007bff; /* Blue button */
            color: white;
            padding: 0 35px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .search-bar button:hover {
            background: #0056b3; /* Darker blue */
        }

        /* --- Dashboard Grid Layout --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr); /* 12-column grid */
            gap: 24px;
        }
        
        /* --- Card Styles --- */
        .card {
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e9ecef; /* Subtle border */
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); /* Very light shadow */
            padding: 24px;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.06); /* Lift on hover */
            transform: translateY(-3px);
        }
        
        /* --- Grid Span Classes --- */
        .card-span-4 { grid-column: span 12; } /* Mobile default */
        .card-span-8 { grid-column: span 12; } /* Mobile default */
        .card-span-12 { grid-column: span 12; }
        
        /* Desktop grid */
        @media (min-width: 992px) {
            .card-span-4 { grid-column: span 4; }
            .card-span-8 { grid-column: span 8; }
        }

        /* --- Core Story Card --- */
        .core-story {
            margin-bottom: 24px;
        }
        .core-story h2 { border-color: #28a745; } /* Green accent */
        .core-story blockquote {
            border-left: 5px solid #28a745;
            padding: 15px;
            margin: 0;
            background: #f1fef6;
            font-size: 1.15em;
            color: #333;
        }
        .core-story p {
            font-size: 1.3em;
            font-weight: 600;
            color: #28a745;
            text-align: right;
            margin-top: 16px;
        }
        
        /* --- Table Styles (Credibility & Share of Voice) --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            text-align: left;
            padding: 14px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        th {
            background: #f8f9fa;
            color: #6c757d;
            font-size: 0.85em;
            text-transform: uppercase;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f8f9fa; /* Striped rows */
        }
        tr:hover {
            background: #f1f3f5;
        }
        
        /* --- Coverage Gaps List --- */
        .gap-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }
        .gap-list li {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }
        .gap-list li:last-child {
            border-bottom: none;
        }
        .gap-list strong {
            color: #dc3545; /* Red for "gaps" */
            font-size: 1.05em;
        }
        .gap-list span {
            display: block;
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 6px;
        }
        
        /* --- Sentiment Bar (NEW DESIGN) --- */
        .sentiment-breakdown {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 1em;
        }
        .sentiment-breakdown span {
            font-weight: 500;
        }
        .sentiment-bar {
            display: flex;
            height: 12px; /* Thinner, cleaner bar */
            border-radius: 6px;
            overflow: hidden;
            background: #e9ecef; /* Background for 0% sections */
        }
        .sentiment-bar div {
            height: 100%;
            transition: width 0.5s ease;
        }
        .negative { background: #e74c3c; }
        .neutral { background: #f39c12; }
        .positive { background: #2ecc71; }
        
        /* --- Utility & State Classes --- */
        .status-card {
            text-align: center;
            padding: 40px;
        }
        .status-card h2 {
            border: none;
            color: #6c757d;
        }
        .error-card {
            background: #fff6f6;
            border-color: #e74c3c;
        }
        .error-card h2 { color: #dc3545; border: none; }

    </style>
</head>
<body>
    
    <div class="search-container">
        <h1>News Analysis Engine</h1>
        <form action="/" method="POST">
            <div class="search-bar">
                <input type="text" name="query" placeholder="Enter news topic (e.g., 'Israel-Hamas conflict')..." value="{{ query or '' }}">
                <button type="submit">Analyze</button>
            </div>
        </form>
    </div>

    <div class="container">

        {% if error %}
            <div class="card error-card status-card">
                <h2>Error Processing Request</h2>
                <p>{{ error }}</p>
            </div>

        {% elif core_story and core_story.description != 'N/A' %}
            
            <div class="card core-story">
                <h2>Core Story</h2>
                <blockquote>{{ core_story.description.claim }}</blockquote>
                <p>Story Agreement: {{ "%.2f"|format(core_story.description.agreement_pct) }}%</p>
            </div>

            <div class="dashboard-grid">
                
                <div class="card card-span-4">
                    <h2>üìä Overall Sentiment</h2>
                    <div class="sentiment-breakdown">
                        <span style="color: #e74c3c;"><strong>Negative:</strong> {{ sentiment_summary.distribution.Negative.percentage }}%</span>
                        <span style="color: #f39c12;"><strong>Neutral:</strong> {{ sentiment_summary.distribution.Neutral.percentage }}%</span>
                        <span style="color: #2ecc71;"><strong>Positive:</strong> {{ sentiment_summary.distribution.Positive.percentage }}%</span>
                    </div>
                    <div class="sentiment-bar">
                        <div class="negative" style="width: {{ sentiment_summary.distribution.Negative.count }}"></div>
                        <div class="neutral" style="width: {{ sentiment_summary.distribution.Neutral.count }}"></div>
                        <div class="positive" style="width: {{ sentiment_summary.distribution.Positive.count }}"></div>
                    </div>
                </div>

                <div class="card card-span-8">
                    <h2>üó£Ô∏è Share of Voice (Top 10)</h2>
                    <table>
                        <tr>
                            <th>Rank</th>
                            <th>Entity</th>
                            <th>Voice Share</th>
                            <th>Article</th>
                        </tr>
                        {% for entity in top_entities %}
                        <tr>
                            <td><strong>{{ loop.index }}</strong></td>
                            <td>{{ entity.canonical_name }}</td>
                            <td>{{ entity.percentage }}</td>
                            <td>{{ entity.example_article_ids }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>

                <div class="card card-span-12">
                    <h2>üîç Key Nuances & Coverage Gaps</h2>
                    <ul class="gap-list">
                        {% for gap in coverage_gaps %}
                        <li>
                            <strong>{{ gap.description }}</strong>
                            <span>(Found in {{ "%.2f"|format(gap.pct_of_articles) }}% of articles)</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="card card-span-12">
                    <h2>üìà Article Credibility Breakdown</h2>
                    <table>
                        <tr>
                            <th>Score</th>
                            <th>Article Title</th>
                            <th>Link to Article</th>
                        </tr>
                        {% for article in credibility_scores %}
                        <tr>
                            <td><strong>{{ "%.2f"|format(article.credibility_score) }}</strong></td>
                            <td>{{ article.title }}</td>
                            <td>{{ article.id }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
            {% elif query %}
            <div class="card status-card">
                <h2>Analyzing "<strong>{{ query }}</strong>"...</h2>
                <p>Please wait. This may take several minutes as the AI agents read, analyze, and score the articles.</p>
                </div>

        {% else %}
            <div class="card status-card">
                <h2>Welcome!</h2>
                <p>Please enter a search topic in the bar above to begin the analysis.</p>
            </div>
        {% endif %}
    
    </div>
</body>
</html> -->
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Analysis Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Simple transition for progress bar */
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
        /* Chart containers must have a defined height for Chart.js */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="h-full font-sans text-gray-900">
    
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <h1 class="text-3xl font-bold tracking-tight text-gray-900 text-center">
                News Analysis Engine
            </h1>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <form id="analysis-form">
            <label for="query" class="block text-sm font-medium text-gray-700">
                Enter news topic
            </label>
            <div class="mt-1 flex rounded-md shadow-sm">
                <input type="text" name="query" id="query"
                    class="block w-full flex-1 rounded-none rounded-l-md border-gray-300 px-4 py-3 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    placeholder="e.g., 'Global AI Regulation'">
                <button type="submit" id="submit-button"
                    class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-indigo-600 px-6 py-3 text-sm font-medium text-white hover:bg-indigo-700 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    Analyze
                </button>
            </div>
        </form>
    </div>

    <!-- Main Content Area: Status & Results -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        
        <!-- 1. Status/Loading Indicator -->
        <div id="status-container" class="hidden">
            <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="text-lg font-medium text-gray-800" id="status-message">
                        Initializing...
                    </div>
                    <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Status Log -->
                <div id="status-log-container" class="hidden">
                    <h3 class="text-sm font-medium text-gray-600">Analysis Log:</h3>
                    <ul id="status-log" class="mt-2 h-32 overflow-y-auto rounded-md bg-gray-50 p-3 text-sm text-gray-500 space-y-1 border">
                        <!-- Log items will be added here -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- 2. Error Message Area -->
        <div id="error-container" class="hidden">
            <div class="rounded-md bg-red-50 p-4 shadow-md border border-red-200">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <!-- Heroicons XCircle -->
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Analysis Failed</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p id="error-message">An unknown error occurred.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Welcome Message -->
        <div id="welcome-container">
             <div class="text-center bg-white rounded-lg shadow border border-gray-200 p-12">
                <h2 class="text-xl font-medium text-gray-700">Welcome!</h2>
                <p class="mt-2 text-gray-500">Please enter a search topic in the bar above to begin the analysis.</p>
            </div>
        </div>
        
        <!-- 4. Results Dashboard (hidden by default) -->
        <div id="results-dashboard" class="hidden">
            
            <!-- Core Story Card -->
            <div class="bg-white rounded-lg shadow border border-gray-200 p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 border-b border-gray-200 pb-3">
                    Core Story
                </h2>
                <blockquote class="mt-4 border-l-4 border-indigo-500 bg-indigo-50 p-4 text-lg font-medium text-indigo-900" id="core-story-description">
                    <!-- Core story description -->
                </blockquote>
                <div class="mt-3 text-right text-2xl font-bold text-indigo-600" id="core-story-agreement">
                    <!-- 0% Agreement -->
                </div>
            </div>

            <!-- Main Dashboard Grid -->
            <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                
                <!-- Left Column (Sentiment & Gaps) -->
                <div class="space-y-6 lg:col-span-1">
                    <!-- Sentiment Card -->
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">
                            Overall Sentiment
                        </h2>
                        <div class="chart-container">
                            <canvas id="sentiment-chart"></canvas>
                        </div>

                        <!-- NEW: Sentiment Clusters -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <h3 class="text-base font-semibold text-gray-800 mb-3">Article Clusters</h3>
                            <div class="space-y-4">
                                <!-- Positive -->
                                <div>
                                    <h4 class="text-sm font-medium text-green-600">Positive Articles</h4>
                                    <ul class="mt-1 list-none space-y-1 text-sm max-h-40 overflow-y-auto" id="positive-cluster-list">
                                        <!-- JS will populate this -->
                                    </ul>
                                </div>
                                <!-- Neutral -->
                                <div>
                                    <h4 class="text-sm font-medium text-amber-600">Neutral Articles</h4>
                                    <ul class="mt-1 list-none space-y-1 text-sm max-h-40 overflow-y-auto" id="neutral-cluster-list">
                                        <!-- JS will populate this -->
                                    </ul>
                                </div>
                                <!-- Negative -->
                                <div>
                                    <h4 class="text-sm font-medium text-red-600">Negative Articles</h4>
                                    <ul class="mt-1 list-none space-y-1 text-sm max-h-40 overflow-y-auto" id="negative-cluster-list">
                                        <!-- JS will populate this -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- END NEW -->
                    </div>
                    
                    <!-- Coverage Gaps Card -->
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">
                            Key Nuances & Gaps
                        </h2>
                        <ul class="space-y-3 max-h-96 overflow-y-auto" id="coverage-gaps-list">
                            <!-- Gaps added by JS -->
                        </ul>
                    </div>
                </div>
                
                <!-- Right Column (Credibility & Voice) -->
                <div class="space-y-6 lg:col-span-2">
                    <!-- Share of Voice Card -->
                     <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">
                            Share of Voice (Top Entities)
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entity</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Voice Share</th>
                                    </tr>
                                
                                <tbody class="bg-white divide-y divide-gray-200" id="top-entities-table">
                                    <!-- Entities added by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Credibility Card -->
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">
                            Article Credibility Breakdown
                        </h2>
                        <div class="overflow-x-auto max-h-[700px] overflow-y-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Article Title</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="credibility-table">
                                    <!-- Articles added by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Chart.js Global Variable ---
        let sentimentChart = null;

        // --- DOM Element References ---
        const form = document.getElementById('analysis-form');
        const queryInput = document.getElementById('query');
        const submitButton = document.getElementById('submit-button');
        
        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const statusLogContainer = document.getElementById('status-log-container');
        const statusLog = document.getElementById('status-log');
        
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        
        const welcomeContainer = document.getElementById('welcome-container');
        const resultsDashboard = document.getElementById('results-dashboard');

        // --- EventSource Global Variable ---
        let eventSource = null;

        /**
         * Main form submission handler
         */
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const query = queryInput.value.trim();
            if (!query) {
                return;
            }
            startAnalysis(query);
        });

        /**
         * Starts the SSE connection and analysis process
         */
        function startAnalysis(query) {
            // 1. Reset the UI
            resetUI();

            // 2. Show status container
            welcomeContainer.classList.add('hidden');
            statusContainer.classList.remove('hidden');
            statusLogContainer.classList.remove('hidden');
            submitButton.disabled = true;
            submitButton.textContent = 'Analyzing...';
            
            // 3. Create the EventSource connection
            const encodedQuery = encodeURIComponent(query);
            eventSource = new EventSource(`/stream-analysis?query=${encodedQuery}`);

            // 4. Handle incoming messages
            eventSource.onmessage = (event) => {
                const eventData = JSON.parse(event.data);
                updateStatus(eventData);
            };

            // 5. Handle errors
            eventSource.onerror = (err) => {
                console.error("EventSource failed:", err);
                showError("Connection to the server failed. Please try again.");
                eventSource.close();
                resetForm();
            };
        }

        /**
         * Updates the UI based on the SSE message
         */
        function updateStatus(eventData) {
            const { step, status, message, data } = eventData;

            // Add to log
            const logItem = document.createElement('li');
            logItem.textContent = `[${status}] ${message}`;
            statusLog.appendChild(logItem);
            statusLog.scrollTop = statusLog.scrollHeight; // Auto-scroll

            if (status === 'error') {
                showError(message);
                eventSource.close();
                resetForm();
                return;
            }

            // Update progress bar (9 total steps)
            const progress = (step / 9) * 100;
            progressBar.style.width = `${progress}%`;
            statusMessage.textContent = message;

            if (status === 'complete') {
                statusMessage.textContent = "Analysis Complete!";
                eventSource.close();
                resetForm();
                renderDashboard(data);
            }
        }

        /**
         * Renders the final dashboard with all results
         */
        function renderDashboard(data) {
            if (!data) {
                showError("No data was returned from the analysis.");
                return;
            }

            // Hide status, show results
            statusContainer.classList.add('hidden');
            resultsDashboard.classList.remove('hidden');

            // 1. Core Story
            document.getElementById('core-story-description').textContent = data.core_story?.description || 'N/A';
            document.getElementById('core-story-agreement').textContent = `${(data.core_story?.agreement_pct || 0).toFixed(1)}% Agreement`;


            // 2. Sentiment Chart
                        // 2. Sentiment Chart
            renderSentimentChart(data.sentiment_summary?.distribution);

// --- NEW: Render Sentiment Clusters ---
            renderSentimentClusters(data.sentiment_summary?.clusters);

            // 3. Coverage Gaps
            const gapsList = document.getElementById('coverage-gaps-list');
            gapsList.innerHTML = '';
            (data.coverage_gaps || []).forEach(gap => {
                const li = document.createElement('li');
                li.className = "p-4 bg-gray-50 rounded-md border border-gray-200"; // Changed padding/margin
                
                // --- MODIFIED: Create link list for gaps ---
                let articleLinksHtml = '';
                if (gap.article_urls && gap.article_urls.length > 0) {
                    articleLinksHtml = gap.article_urls.map((url, index) => {
                        if (!url) return '';
                        let displayUrl = url.replace(/^(https?:\/\/)?(www\.)?/, '');
                        if (displayUrl.length > 40) displayUrl = displayUrl.substring(0, 40) + '...';
                        return `<li class="mt-1"><a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 hover:underline break-all" title="${url}">
                            Article ${index + 1} (${displayUrl})
                        </a></li>`;
                    }).join('');
                } else {
                    articleLinksHtml = '<li class="text-gray-500 italic text-sm mt-1">No specific articles found for this gap.</li>';
                }
                
                li.innerHTML = `
                    <strong class="text-gray-800">${gap.description}</strong>
                    <span class="block text-sm text-gray-500 mt-1">
                        (Found in ${(gap.pct_of_articles || 0).toFixed(1)}% of articles)
                    </span>
                    <ul class="list-none space-y-1 text-sm mt-2 pt-2 border-t border-gray-200">
                        ${articleLinksHtml}
                    </ul>
                `;
                // --- END MODIFIED ---
                
                gapsList.appendChild(li);
            });
            if (!gapsList.hasChildNodes()) {
                gapsList.innerHTML = `<li class="text-gray-500 italic">No significant coverage gaps found.</li>`;
            }

            // 4. Share of Voice
            const entitiesTable = document.getElementById('top-entities-table');
            entitiesTable.innerHTML = '';
            (data.top_entities || []).forEach(entity => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">${entity.canonical_name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${(entity.percentage || 0).toFixed(1)}%</td>
                `;
                entitiesTable.appendChild(tr);
            });
            if (!entitiesTable.hasChildNodes()) {
                entitiesTable.innerHTML = `<tr><td colspan="2" class="px-4 py-3 text-gray-500 italic">No entities found.</td></tr>`;
            }

            // 5. Credibility
            const credibilityTable = document.getElementById('credibility-table');
            credibilityTable.innerHTML = '';
            (data.credibility_scores || []).forEach(article => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                const articleUrl = article.id || article.url || '#';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-bold ${getScoreColor(article.credibility_score)}">
                        ${(article.credibility_score || 0).toFixed(1)}
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">
                        <a href="${articleUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline">
                            ${article.title}
                        </a>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${article.source || 'Unknown'}</td>
                `;
                credibilityTable.appendChild(tr);
            });
             if (!credibilityTable.hasChildNodes()) {
                credibilityTable.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-gray-500 italic">No articles to score.</td></tr>`;
            }
        }

        /**
         * Renders the doughnut chart for sentiment
         */
         function renderSentimentChart(distribution) {
            const ctx = document.getElementById('sentiment-chart').getContext('2d');
            
            const data = {
                labels: ['Positive', 'Neutral', 'Negative'],
                datasets: [{
                    label: 'Sentiment',
                    data: [
                        distribution?.Positive?.percentage || 0,
                        distribution?.Neutral?.percentage || 0,
                        distribution?.Negative?.percentage || 0
                    ],
                    backgroundColor: [
                        'rgb(34, 197, 94)',  // green-500
                        'rgb(245, 158, 11)', // amber-500
                        'rgb(239, 68, 68)'   // red-500
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };

            if (sentimentChart) {
                sentimentChart.destroy();
            }

            sentimentChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * NEW: Renders the article cluster hyperlinks
         */
         function renderSentimentClusters(clusters) {
            const posList = document.getElementById('positive-cluster-list');
            const neuList = document.getElementById('neutral-cluster-list');
            const negList = document.getElementById('negative-cluster-list');

            const emptyHtml = '<li class="text-gray-500 italic">No articles were found.</li>';

            const populateList = (listEl, urls) => {
                listEl.innerHTML = ''; // Clear old items
                if (!urls || urls.length === 0) {
                    listEl.innerHTML = emptyHtml;
                    return;
                }
                
                urls.forEach((url, index) => {
                    if (!url) return; // Skip null or empty URLs

                    // Truncate URL for display
                    let displayUrl = url.replace(/^(httpshttps?:\/\/)?(www\.)?/, '');
                    if (displayUrl.length > 45) {
                        displayUrl = displayUrl.substring(0, 45) + '...';
                    }
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 hover:underline break-all" title="${url}">
                            Article ${index + 1} (${displayUrl})
                        </a>
                    `;
                    listEl.appendChild(li);
                });
            };

            populateList(posList, clusters?.Positive);
            populateList(neuList, clusters?.Neutral);
            populateList(negList, clusters?.Negative);
        }

        /**
         * Helper to color-code credibility scores
         */
        function getScoreColor(score) {
            if (score >= 75) return 'text-green-600';
            if (score >= 50) return 'text-yellow-600';
            return 'text-red-600';
        }

        /**
         * Shows the error message container
         */
        function showError(message) {
            statusContainer.classList.add('hidden');
            resultsDashboard.classList.add('hidden');
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        /**
         * Resets the form button and loading state
         */
        function resetForm() {
            submitButton.disabled = false;
            submitButton.textContent = 'Analyze';
        }
        
        /**
         * Resets the entire UI to its initial state
         */
        function resetUI() {
            // Clear results
            resultsDashboard.classList.add('hidden');
            
            // Clear status
            statusContainer.classList.add('hidden');
            statusLog.innerHTML = '';
            progressBar.style.width = '0%';
            
            // Clear error
            errorContainer.classList.add('hidden');
            errorMessage.textContent = '';

            // Show welcome
            welcomeContainer.classList.remove('hidden');

            // Reset chart
            if (sentimentChart) {
                sentimentChart.destroy();
                sentimentChart = null;
            }
        }
    </script>
</body>
</html>